services:
  # ============================================
  # TAILSCALE SIDECAR
  # ============================================

  tailscale-arena:
    image: tailscale/tailscale:latest
    hostname: arena
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
    volumes:
      - ./tailscale_state/arena:/var/lib/tailscale
    cap_add:
      - net_admin
    restart: unless-stopped

  # ============================================
  # MAIN SERVICE
  # ============================================

  agent-arena:
    build:
      context: .
      dockerfile: build1.dockerfile
    container_name: agentarena-dev
    depends_on:
      - tailscale-arena
    network_mode: service:tailscale-arena
    volumes:
      # Host paths - your actual Windows folders
      - E:/Code:/code
      - E:/Docker/:/code/Docker/
      - E:/Vault:/vault
      # Named volumes - persist container config across rebuilds
      - arena_dev_home:/home/dev
      - arena_root_home:/root
      # API server mount for hot-fixes without rebuild
      - ./api:/srv/api
      # Security: Hide sensitive files from sandbox (overlay with empty file)
      - ./sandbox_overrides/empty_env:/code/AgentArena/.env:ro
      - ./sandbox_overrides/empty_env:/code/AgentArena/.env.example:ro
    restart: unless-stopped

volumes:
  arena_dev_home:
    driver: local
  arena_root_home:
    driver: local
